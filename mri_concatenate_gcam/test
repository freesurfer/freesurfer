#!/usr/bin/env bash

# Test for mri_concatenate_gcam.


function error_exit()
{
    errcode=$?
    echo FAILED
    exit $errcode
}


set -e # Exit on error.
set -x # Print commands.
trap error_exit ERR


# Set up.
source fsenv.sh &> /dev/null
#export FREESURFER_HOME=../distribution
export SUBJECTS_DIR=""
cmd=./mri_concatenate_gcam
data=testdata.tar.gz
dir=$PWD/${data%%.*} # Substring before first point.
umask 002
tar -zxvf $data


# Copy LTA:
in=$dir/im1_to_im2.lta
out=$dir/out.lta
$cmd $in $out
diff -I '#' $out $out # Ignore comments.


# Concatenate LTAs:
out=$dir/out.lta
$cmd $dir/{im3_to_im1,im1_to_im2}.lta $out
num_lta=$(sed -n 's/^nxforms[ ]*=[ ]*//p' $out)
[[ $num_lta -eq 2 ]] || exit 1


# Ensure inv(A*B) = inv(B) * inv(A):
in=$out
lta1=$dir/out1.lta
$cmd --reduce $in $lta1
$cmd --invert $lta1 $lta1
num_lta=$(sed -n 's/^nxforms[ ]*=[ ]*//p' $lta1)
[[ $num_lta -eq 1 ]] || exit 1

lta2=$dir/out2.lta
$cmd --invert $in $lta2
$cmd --reduce $lta2 $lta2
num_lta=$(sed -n 's/^nxforms[ ]*=[ ]*//p' $lta2)
[[ $num_lta -eq 1 ]] || exit 1

in=$dir/im1.mgz
out1=$dir/out1.mgz
out2=$dir/out1.mgz
mri_convert --apply_transform $lta1 $in $out1
mri_convert --apply_transform $lta2 $in $out2
mri_diff --thresh '0.01' $out1 $out2


# Change the GCAM source image space:
out=$dir/out.mgz
gcam=$dir/gcam.m3z
src=$dir/im2_in_space1.mgz
$cmd --srcgeom $dir/im1.mgz $dir/im2_to_im3.m3z $gcam
mri_convert --like $dir/im1.mgz $dir/im2.mgz $src
mri_convert -at $gcam $src $out
mri_diff $out $dir/ref1.mgz


# Change the GCAM destination space:
out=$dir/out.mgz
gcam=$dir/gcam.m3z
$cmd --dstgeom $dir/im1.mgz $dir/im2_to_im3.m3z $gcam
mri_convert -at $gcam $dir/im2.mgz $out
mri_diff $out $dir/ref2.mgz


# Concatenate LTA with GCAM:
out=$dir/out.mgz
gcam=$dir/gcam.m3z
$cmd $dir/im1_to_im2.lta $dir/im2_to_im3.m3z $gcam
mri_convert -at $gcam $dir/im1.mgz $out
mri_diff $out $dir/ref3.mgz


# Concatenate GCAM with LTA:
out=$dir/out.mgz
gcam=$dir/gcam.m3z
$cmd $dir/im2_to_im3.m3z $dir/im3_to_im1.lta $gcam
mri_convert -at $gcam $dir/im2.mgz $out
mri_diff $out $dir/ref4.mgz


# Concatenate LTA with GCAm with LTA:
out=$dir/out.mgz
gcam=$dir/gcam.m3z
$cmd $dir/im1_to_im2.lta $dir/im2_to_im3.m3z $dir/im3_to_im1.lta $gcam
mri_convert -at $gcam $dir/im1.mgz $out
mri_diff $out $dir/ref5.mgz


# Concatenate two GCAMs:
out=$dir/out.mgz
gcam=$dir/gcam.m3z
$cmd $dir/im2_to_im3.m3z $dir/im3_to_im2.m3z $gcam
mri_convert -at $gcam $dir/im2.mgz $out
mri_diff $out $dir/ref6.mgz


# Compare to repeatedly interpolating, e.g.:
# out=$dir/out.mgz
# in=$dir/im1.mgz
# mri_convert -at $dir/im1_to_im2.lta $in $out
# mri_convert -at $dir/im2_to_im3.m3z $out $out
# mri_convert -at $dir/im3_to_im1.lta $out $out


echo PASSED
rm $dir/*
rmdir $dir
exit 0

